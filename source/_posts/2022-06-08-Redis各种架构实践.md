---
title: Redis各种架构实践(基于docker)
date: 2022-06-08 23:11:54
tags:
- redis
- sentinel
---
## 单机模式

### 不带配置文件
```
docker run --name redis -p 6379:6379 -v /<dir>/docker/redis/data:/data redis --requirepass 123456
```

### 带配置文件
```
docker run --name redis -p 6379:6379 -v /<dir>/docker/redis/data:/data -v /<dir>/docker/redis/config/redis.conf:/etc/redis/redis.conf redis redis-server /etc/redis/redis.conf
```

## 主从复制

### 不带配置文件
#### 1.1 master(主库)

````
# 运行服务
docker run -it --name redis-master -d -p 6300:6379 redis redis-server --requirepass 123456
# 测试连接redis
docker exec -it redis-master redis-cli -a 123456
````

##### 1.2 slave(从库)
```
# 运行服务
docker run -it --name redis-slave -d -p 6301:6379 redis redis-server --requirepass 123456
# 测试连接redis
docker exec -it redis-slave redis-cli -a 123456
```

#### 1.3 从库配置
```
#查询docker容器所对应的真是网络ip
docker inspect <containerid>

#进入slave
docker exec -it redis-slave redis-cli -a 123456

slaveof <master-ip> <master-port>。<master-ip>为主库服务ip，<master-port>表示主库所在端口，默认6379

```
#### 1.4 密码认证
```
config set masterauth <master-password>。<master-password>即为主库访问密码
```
#### 1.5 测试命令
```
#查看主从配置
输入info或info Replication
```


### 带配置文件
```
docker run --name redis-master -p 6379:6379 -v /<dir>/docker/redis/data:/data -v /<dir>/docker/redis/config/redis.conf:/etc/redis/redis.conf redis redis-server /etc/redis/redis.conf
```


## 哨兵模式

### 最小化搭建
至少需要3个Sentinel实例，且3个实例应该在独立方式发生故障的不同的物理机或者虚拟机上。

以下是一组 sentinel.conf

```
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 60000
sentinel failover-timeout mymaster 180000
sentinel parallel-syncs mymaster 1

sentinel monitor resque 192.168.1.3 6380 4
sentinel down-after-milliseconds resque 10000
sentinel failover-timeout resque 180000
sentinel parallel-syncs resque 5

```

以上配置表示有两组哨兵，监控了两组实例，其主节点分别是：mymaster、resque

#### sentinel 的语法

```
sentinel monitor <master-group-name> <ip> <port> <quorum>
```

quorum:仲裁参数，代表需要几个哨兵发现主节点下线，才能投票选出新的主节点

#TODO

### 1.3 基本配置
```
replicaof <masterip> <masterport>
```

#TODO